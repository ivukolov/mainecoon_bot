name: Deploy with Docker Compose

on:
  push:
    branches:
      - '*'
jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Deploy and restart containers
      uses: appleboy/ssh-action@v0.1.7
      id: deploy
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script_stop: true
        script: |
          set -e
          echo "–ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Å–±–æ—Ä–∫–∏..."
          
          cd ${{ secrets.PROJECT_PATH }}
          
          echo "–ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
          git fetch origin
          git pull origin master
          
          echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
          docker-compose down
          
          echo "–°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
          docker-compose up -d --build
          
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
          sleep 10
          docker-compose ps
          
          echo "–°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

    - name: Send success notification
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
          
          –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          –í–µ—Ç–∫–∞: ${{ github.ref }}
          –ö–æ–º–º–∏—Ç: ${{ github.sha }}
          –ê–≤—Ç–æ—Ä: ${{ github.actor }}
          
          üê≥ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å–æ–±—Ä–∞–Ω—ã –∏ –∑–∞–ø—É—â–µ–Ω—ã!
          üåê –°–µ—Ä–≤–µ—Ä: ${{ secrets.SERVER_HOST }}
          ‚è∞ –í—Ä–µ–º—è: ${{ steps.deploy.outputs.time }}

  handle-failure:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
    - name: Send failure notification
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ‚ùå –°–±–æ—Ä–∫–∞ –∑–∞–≤–∞—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π!
          
          –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          –í–µ—Ç–∫–∞: ${{ github.ref }}
          –ö–æ–º–º–∏—Ç: ${{ github.sha }}
          –ê–≤—Ç–æ—Ä: ${{ github.actor }}
          
          üö® –õ–æ–≥ –æ—à–∏–±–∫–∏:
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          üîß –°–µ—Ä–≤–µ—Ä: ${{ secrets.SERVER_HOST }}